#!/usr/bin/env bpftrace

/*
 * ç›‘æ§: tracepoint:workqueue:workqueue_queue_work
 * å­—æ®µ: args->function (å·²ç¡®è®¤ä¸º void *)
 * åŸç†: å½“å†…æ ¸è¦æŠŠ bpf_map_free_deferred æ‰”è¿›å·¥ä½œé˜Ÿåˆ—æ—¶ï¼Œè§¦å‘æ­¤è„šæœ¬ã€‚
 */

tracepoint:workqueue:workqueue_queue_work
{
    // 1. è·å–æ­£åœ¨è¢«è°ƒåº¦çš„ä»»åŠ¡å‡½æ•°æŒ‡é’ˆ
    $target_func = args->function;

    // 2. æ ¸å¿ƒåˆ¤æ–­ï¼šè¿™ä¸ªä»»åŠ¡æ˜¯ä¸æ˜¯ BPF Map çš„å»¶è¿Ÿé‡Šæ”¾å‡½æ•°ï¼Ÿ
    // bpf_map_free_deferred å¿…é¡»å­˜åœ¨åœ°å€ï¼Œå› ä¸ºå®ƒæ˜¯é€šè¿‡å‡½æ•°æŒ‡é’ˆä¼ é€’ç»™ INIT_WORK çš„
    if ($target_func == kaddr("bpf_map_free_deferred")) {
        
        printf("\nğŸ”¥ æ•è·åˆ° Map é”€æ¯æäº¤ (Triggered) ğŸ”¥\n");
        printf("    Comm: %s | PID: %d\n", comm, pid);
        
        // åŒé‡ç¡®è®¤ï¼šæ‰“å°ä¸€ä¸‹å‡½æ•°åï¼Œç¡®ä¿æ²¡æŠ“é”™
        printf("    Task Function: %s\n", ksym($target_func));
        
        printf("\nğŸ‘‡ğŸ‘‡ğŸ‘‡ å®Œæ•´çš„å†…æ ¸è°ƒç”¨æ ˆ (User -> Kernel) ğŸ‘‡ğŸ‘‡ğŸ‘‡\n");
        print(kstack);
    }
}